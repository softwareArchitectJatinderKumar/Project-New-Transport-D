<!-- 1. Loader Section Refactored to @if -->
@if (loadingIndicator) {
<div class="fullscreen-loader">
    <div class="custom-spinner-overlay">
        <div class="custom-spinner-content text-center">
            <img src="assets/images/spinner.gif" alt="Loading..." />
        </div>
    </div>
</div>
}

<!-- 2. Main Container Refactored to @if/@else -->
@if (isLoginFailed === false) {
<div class="container-fluid py-4" id="OBPHeadMapping">

  <h2 class="mb-4 text-primary">Metric Mapping Management</h2>

  <div class="card shadow mb-5">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">{{ isUpdateMode ? 'Update Mapping Record' : 'Add New Mapping Record' }}</h5>
    </div>
    <div class="card-body">
      <form [formGroup]="mappingForm" (ngSubmit)="onSubmit()">
        <div class="row g-3">

          <div class="col-md-6">
            <label for="headUid" class="form-label">Head UID <span class="text-danger">*</span></label>
            <input type="number" formControlName="HeadUID" class="form-control"
              [class.is-invalid]="mappingForm.get('HeadUID')?.invalid && mappingForm.get('HeadUID')?.touched">
            <div class="invalid-feedback" @if="mappingForm.get('HeadUID')?.errors?.['required']">Head UID is required.
            </div>
            <div class="invalid-feedback" @if="mappingForm.get('HeadUID')?.errors?.['pattern']">Must be a number.
            </div>
          </div>

          <div class="col-md-6">
            <label for="assistantUid" class="form-label">Assistant UID <span class="text-danger">*</span></label>
            <input type="number" formControlName="AssistantUID" class="form-control"
              [class.is-invalid]="mappingForm.get('AssistantUID')?.invalid && mappingForm.get('AssistantUID')?.touched">
            <div class="invalid-feedback" @if="mappingForm.get('AssistantUID')?.errors?.['required']">Assistant UID is
              required.</div>
          </div>

          <div class="col-md-6">
            <label for="metricId" class="form-label">Metric ID <span class="text-danger">*</span></label>
            <input type="number" formControlName="MetricId" class="form-control"
              [class.is-invalid]="mappingForm.get('MetricId')?.invalid && mappingForm.get('MetricId')?.touched">
            <div class="invalid-feedback" @if="mappingForm.get('MetricId')?.errors?.['required']">Metric ID is
              required.</div>
          </div>

            <!-- 3. Conditional Form Fields Refactored to @if -->
          @if (isUpdateMode) {
          <div class="col-md-6">
            <label class="form-label d-block">Is Active <span class="text-danger">*</span></label>
            <div class="btn-group" role="group" aria-label="Is Active options">
                <!-- 4. Radio Group Refactored to @for -->
              @for (option of isActiveOptions; track option.value) {
                <input type="radio" class="btn-check" [id]="'active-' + option.value" name="IsActive"
                  [value]="option.value" formControlName="IsActive">
                <label class="btn btn-outline-secondary" [for]="'active-' + option.value">{{ option.label }}</label>
              }
            </div>
            <div class="invalid-feedback d-block"
              @if="mappingForm.get('IsActive')?.invalid && mappingForm.get('IsActive')?.touched">Please select an
              option.</div>
          </div>
          }
            <!-- 3. Conditional Form Fields Refactored to @if -->
          @if (isUpdateMode) {
          <div class="col-md-12">
            <label for="remarks" class="form-label">Remarks <span class="text-danger">*</span></label>
            <textarea id="remarks" formControlName="Remarks" class="form-control" rows="3"
              [class.is-invalid]="mappingForm.get('Remarks')?.invalid && mappingForm.get('Remarks')?.touched"></textarea>
            <div class="invalid-feedback"
              @if="mappingForm.get('Remarks')?.invalid && mappingForm.get('Remarks')?.touched">Remarks are required
              for updates.</div>
          </div>
          }
          
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label d-block">Type <span class="text-danger">*</span></label>
              <div class="btn-group" role="group" aria-label="Type options">
                <!-- 4. Radio Group Refactored to @for -->
                @for (type of typeOptions; track type) {
                  <input type="radio" class="btn-check" [id]="'type-' + type" name="Type" [value]="type"
                    formControlName="Type">
                  <label class="btn btn-outline-secondary" [for]="'type-' + type">{{ type }}</label>
                }
              </div>
              <div class="invalid-feedback d-block"
                @if="mappingForm.get('Type')?.invalid && mappingForm.get('Type')?.touched">
                Please select a type.</div>
            </div>


            <div class=" col-md-4 mt-5">
              <button type="submit" class="btn btn-lg w-30"
                [ngClass]="{'btn-primary': !isUpdateMode, 'btn-info': isUpdateMode}"
                [disabled]="mappingForm.invalid">
                <i class="bi bi-cloud-arrow-up"></i> {{ isUpdateMode ? 'Update Record' : 'Submit Record' }}
              </button>
            </div>
            <div class=" col-md-4 mt-5">
              <button type="button" class="btn btn-secondary w-30 mt-2" @if="isUpdateMode" (click)="onCancelUpdate()">
                Cancel Update
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="card shadow ">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0  ">Existing Mappings Details</h5>
    </div>
    <div class="card-body p-0">
      <div class="p-3 d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <label class="me-2 mb-0">Search:</label>
          <input class="form-control me-3" style="width: 240px;" placeholder="Search..."
            (input)="onSearch($any($event.target).value)">
          <label class="me-2 mb-0">Per page:</label>
          <select class="form-select" style="width: 100px;" (change)="onPageSizeChange($any($event.target).value)">
                <!-- 4. Select Options Refactored to @for -->
            @for (s of pageSizes; track s) {
              <option [value]="s" [selected]="s === pageSize">{{ s }}</option>
            }
          </select>
          <button class="btn btn-secondary ms-3" (click)="exportToExcel()">
             Export to Excel
          </button>
        </div>
        <div class="text-muted">Total: {{ totalRecords }}</div>
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0">
          <thead class="table-danger bg-dark">
            <tr>
                <!-- 4. Table Header Refactored to @for -->
              @for (col of tableColumns; track col) { 
              <th> <span class="text-dark">{{ col }}</span></th>
              }
            </tr>
          </thead>
          <tbody>
                <!-- 4. Table Body Rows Refactored to @for -->
            @for (record of (displayedData$ | async); track record) {
            <tr>
                <!-- 4. Table Body Columns Refactored to @for -->
              @for (col of tableColumns; track col) {
              <td>
                    <!-- 5. Switch Case Refactored to @switch -->
                    @switch (col) {
                        @case ('Actions') {
                            <button type="button" class="btn btn-sm btn-info me-2" (click)="onEdit(record)">
                                <i class="mdi mdi-pencil"></i>
                            </button>
                        }
                        @case ('isActive') {
                            <button type="button" class="btn btn-sm btn-info me-2 btn-circle" (click)="onDelete(record)">
                                <i class="mdi mdi-pencil"></i>
                            </button>
                        }
                        @default {
                            {{ $any(record)[col] }}
                        }
                    }
              </td>
              }
            </tr>
            }
          </tbody>
            <!-- 3. Conditional Footer Refactored to @if -->
          @if ((displayedData$ | async)?.length === 0) {
          <tfoot >
            <tr>
              <td [attr.colspan]="tableColumns.length" class="text-center text-muted">No records found.</td>
            </tr>
          </tfoot>
          }
        </table>
      </div>
      <div class="d-flex justify-content-between align-items-center p-3">
        <div>
          <button class="btn btn-info me-2" [disabled]="currentPage <= 1"
            (click)="goToPage(currentPage - 1)">Prev</button>
          <button class="btn btn-primary" [disabled]="currentPage >= totalPages"
            (click)="goToPage(currentPage + 1)">Next</button>
        </div>
        <div>Page {{ currentPage }} / {{ totalPages }}</div>
      </div>
    </div>
  </div>
</div>
} @else {
  <!-- The former <ng-template #loginFailed> content -->
  <div class="card shadow-sm">
    <div class="card-body text-center py-5">
      <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
      <h4 class="text-danger">Access Denied</h4>
    </div>
  </div>
}

<!-- <div *ngIf="loadingIndicator" class="fullscreen-loader">
    <div class="custom-spinner-overlay" *ngIf="loadingIndicator">
        <div class="custom-spinner-content text-center">
            <img src="assets/images/spinner.gif" alt="Loading..." />
           
        </div>
    </div>
</div>

<div class="container-fluid py-4" id="OBPHeadMapping" *ngIf="isLoginFailed==false; else loginFailed">

  <h2 class="mb-4 text-primary">Metric Mapping Management</h2>

  <div class="card shadow mb-5">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">{{ isUpdateMode ? 'Update Mapping Record' : 'Add New Mapping Record' }}</h5>
    </div>
    <div class="card-body">
      <form [formGroup]="mappingForm" (ngSubmit)="onSubmit()">
        <div class="row g-3">

          <div class="col-md-6">
            <label for="headUid" class="form-label">Head UID <span class="text-danger">*</span></label>
            <input type="number" formControlName="HeadUID" class="form-control"
              [class.is-invalid]="mappingForm.get('HeadUID')?.invalid && mappingForm.get('HeadUID')?.touched">
            <div class="invalid-feedback" *ngIf="mappingForm.get('HeadUID')?.errors?.['required']">Head UID is required.
            </div>
            <div class="invalid-feedback" *ngIf="mappingForm.get('HeadUID')?.errors?.['pattern']">Must be a number.
            </div>
          </div>

          <div class="col-md-6">
            <label for="assistantUid" class="form-label">Assistant UID <span class="text-danger">*</span></label>
            <input type="number" formControlName="AssistantUID" class="form-control"
              [class.is-invalid]="mappingForm.get('AssistantUID')?.invalid && mappingForm.get('AssistantUID')?.touched">
            <div class="invalid-feedback" *ngIf="mappingForm.get('AssistantUID')?.errors?.['required']">Assistant UID is
              required.</div>
          </div>

          <div class="col-md-6">
            <label for="metricId" class="form-label">Metric ID <span class="text-danger">*</span></label>
            <input type="number" formControlName="MetricId" class="form-control"
              [class.is-invalid]="mappingForm.get('MetricId')?.invalid && mappingForm.get('MetricId')?.touched">
            <div class="invalid-feedback" *ngIf="mappingForm.get('MetricId')?.errors?.['required']">Metric ID is
              required.</div>
          </div>
          <div class="col-md-6" *ngIf="isUpdateMode">
            <label class="form-label d-block">Is Active <span class="text-danger">*</span></label>
            <div class="btn-group" role="group" aria-label="Is Active options">
              <ng-container *ngFor="let option of isActiveOptions">
                <input type="radio" class="btn-check" [id]="'active-' + option.value" name="IsActive"
                  [value]="option.value" formControlName="IsActive">
                <label class="btn btn-outline-secondary" [for]="'active-' + option.value">{{ option.label }}</label>
              </ng-container>
            </div>
            <div class="invalid-feedback d-block"
              *ngIf="mappingForm.get('IsActive')?.invalid && mappingForm.get('IsActive')?.touched">Please select an
              option.</div>
          </div>

          <div class="col-md-12" *ngIf="isUpdateMode">
            <label for="remarks" class="form-label">Remarks <span class="text-danger">*</span></label>
            <textarea id="remarks" formControlName="Remarks" class="form-control" rows="3"
              [class.is-invalid]="mappingForm.get('Remarks')?.invalid && mappingForm.get('Remarks')?.touched"></textarea>
            <div class="invalid-feedback"
              *ngIf="mappingForm.get('Remarks')?.invalid && mappingForm.get('Remarks')?.touched">Remarks are required
              for updates.</div>
          </div>
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label d-block">Type <span class="text-danger">*</span></label>
              <div class="btn-group" role="group" aria-label="Type options">
                <ng-container *ngFor="let type of typeOptions">
                  <input type="radio" class="btn-check" [id]="'type-' + type" name="Type" [value]="type"
                    formControlName="Type">
                  <label class="btn btn-outline-secondary" [for]="'type-' + type">{{ type }}</label>
                </ng-container>
              </div>
              <div class="invalid-feedback d-block"
                *ngIf="mappingForm.get('Type')?.invalid && mappingForm.get('Type')?.touched">
                Please select a type.</div>
            </div>


            <div class=" col-md-4 mt-5">
              <button type="submit" class="btn btn-lg w-30"
                [ngClass]="{'btn-primary': !isUpdateMode, 'btn-info': isUpdateMode}"
                [disabled]="mappingForm.invalid">
                <i class="bi bi-cloud-arrow-up"></i> {{ isUpdateMode ? 'Update Record' : 'Submit Record' }}
              </button>
            </div>
            <div class=" col-md-4 mt-5">
     
              <button type="button" class="btn btn-secondary w-30 mt-2" *ngIf="isUpdateMode" (click)="onCancelUpdate()">
                Cancel Update
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="card shadow ">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0  ">Existing Mappings Details</h5>
    </div>
    <div class="card-body p-0">
      <div class="p-3 d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <label class="me-2 mb-0">Search:</label>
          <input class="form-control me-3" style="width: 240px;" placeholder="Search..."
            (input)="onSearch($any($event.target).value)">
          <label class="me-2 mb-0">Per page:</label>
          <select class="form-select" style="width: 100px;" (change)="onPageSizeChange($any($event.target).value)">
            <option *ngFor="let s of pageSizes" [value]="s" [selected]="s === pageSize">{{ s }}</option>
          </select>
          <button class="btn btn-secondary ms-3" (click)="exportToExcel()">
             Export to Excel
          </button>
        </div>
        <div class="text-muted">Total: {{ totalRecords }}</div>
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0">
          <thead class="table-danger bg-dark">
            <tr>
              <th *ngFor="let col of tableColumns"> <span class="text-dark">{{ col }}</span></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let record of displayedData$ | async">
              <td *ngFor="let col of tableColumns">
                <ng-container [ngSwitch]="col">
                  <ng-container *ngSwitchCase="'Actions'">
                    <button type="button" class="btn btn-sm btn-info me-2" (click)="onEdit(record)">
                        <i class="mdi mdi-pencil"></i>
                    </button>
                  </ng-container>
                  <ng-container *ngSwitchCase="'isActive'">
                 
                    <button type="button" class="btn btn-sm btn-info me-2 btn-circle" (click)="onDelete(record)">
                      <i class="mdi mdi-pencil"></i>
                    </button>
                  </ng-container>
                  <ng-container *ngSwitchDefault>
                    {{ $any(record)[col] }}
                  </ng-container>
                  </ng-container>
                  </td>
            </tr>
          </tbody>
          <tfoot *ngIf="(displayedData$ | async)?.length === 0">
            <tr>
              <td [attr.colspan]="tableColumns.length" class="text-center text-muted">No records found.</td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="d-flex justify-content-between align-items-center p-3">
        <div>
          <button class="btn btn-info me-2" [disabled]="currentPage <= 1"
            (click)="goToPage(currentPage - 1)">Prev</button>
          <button class="btn btn-primary" [disabled]="currentPage >= totalPages"
            (click)="goToPage(currentPage + 1)">Next</button>
        </div>
        <div>Page {{ currentPage }} / {{ totalPages }}</div>
      </div>
    </div>
  </div>
</div>
<ng-template #loginFailed>
  <div class="card shadow-sm">
    <div class="card-body text-center py-5">
      <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
      <h4 class="text-danger">Access Denied</h4>
    </div>
  </div>
</ng-template> -->